#!/usr/bin/env python
"""
Usage: untunes <path/to/itunes/library.xml> <dir> [<dir> ..]
"""
import os
import sys
import plistlib

try:
    from urllib.parse import urlparse
    from urllib.request import url2pathname
except ImportError:
    from urlparse import urlparse
    from urllib import url2pathname


def get_tracks_from_library(library):
    pl = plistlib.readPlist(library)
    tracks = []
    for id in pl['Tracks']:
        url = pl['Tracks'][id]['Location']
        if not url.startswith('file:'):
            continue
        path = url2pathname(urlparse(url).path)
        tracks.append(path)
    return set(tracks)


def get_files_from_dirs(dirs):
    fns = []
    for d in dirs:
        for root, _, files in os.walk(d):
            for f in files:
                fns.append(os.path.join(root, f))
    return set(fns)


def main(library, *dirs):
    itunes = get_tracks_from_library(library)
    disk = get_files_from_dirs(dirs)
    unimported = sorted(disk - itunes)
    if unimported:
        print('\n'.join(unimported))


if __name__ == '__main__':
    if len(sys.argv) < 3:
        print(__doc__.strip())
        sys.exit(1)

    main(*sys.argv[1:])
